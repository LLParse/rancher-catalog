version: '2'

services:
    etcd-6:
        image: rancher/etcd:v2.3.7-11
        labels:
            io.rancher.scheduler.affinity:host_label_soft: etcd=true
            io.rancher.scheduler.affinity:container_label_ne: io.rancher.stack_service.name=$${stack_name}/$${service_name}
        environment:
            RANCHER_DEBUG: 'true'
            EMBEDDED_BACKUPS: 'true'
            BACKUP_PERIOD: 1s
            BACKUP_RETENTION: 1m
        volumes:
        - etcd:/pdata
        - etcd_backup:/data-backup

# Takes 2-3 minutes for plugin to format this block device as ext4 and host goes into reconnecting state (`docker ps` hangs)
# https://github.com/docker/docker/issues/18504
# to fix, we lazy init during FS creation
volumes:
    etcd:
        driver: local
    etcd_backup:
        driver: rancher-ebs
        driver_opts:
            # GiB (500 GiB minimum for sc1)
            size: 500
            # Throughput Optimized HDD
            volumeType: st1